<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>WhatsApp Chat Viewer - Read and View Your Chat History</title>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="style.css" as="style">
    <link rel="preload" href="overlay.css" as="style">
    <link rel="preload" href="./images/menu_24dp_E3E3E3.svg" as="image">
    <link rel="preload" href="./images/arrow-up-thick.svg" as="image">
    <link rel="preload" href="./images/external-link.svg" as="image">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" as="style">
    
    <!-- Deferred CSS loading -->
    <link rel="stylesheet" href="style.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="overlay.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" media="print" onload="this.media='all'">
    
    <!-- Meta tags -->
    <meta name="description" content="Free online tool to read and view WhatsApp chat exports. Open your ZIP/TXT chat files in a clean format. Easy to use - no download needed.">
    <meta name="keywords" content="whatsapp chat reader, view whatsapp chat, open whatsapp export, read whatsapp backup, whatsapp chat viewer, whatsapp history">
    <meta http-equiv="Cache-Control" content="max-age=31536000, public">
    <meta property="article:modified_time" content="2024-03-14T12:00:00+00:00">
    <meta property="og:updated_time" content="2024-03-14T12:00:00+00:00">
    
    <!-- Open Graph and Twitter Cards -->
    <meta property="og:title" content="WhatsApp Chat Viewer - Read and View Your Chat History">
    <meta property="og:description" content="Free online tool to read and view WhatsApp chat exports. Open your ZIP/TXT chat files in a clean format. Easy to use - no download needed.">
    <meta property="og:image" content="https://jmegaraujo.github.io/WhatsAppChatViewer/images/og-image.png">
    <meta property="og:url" content="https://jmegaraujo.github.io/WhatsAppChatViewer/">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="WhatsApp Chat Viewer - Read and View Your Chat History">
    <meta name="twitter:description" content="Free online tool to read and view WhatsApp chat exports. Open your ZIP/TXT chat files in a clean format. Easy to use - no download needed.">
    <meta name="twitter:image" content="https://jmegaraujo.github.io/WhatsAppChatViewer/images/og-image.png">
    
    <link rel="canonical" href="https://jmegaraujo.github.io/WhatsAppChatViewer/">
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">

    <!-- Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "WhatsApp Chat Viewer",
      "description": "Free online tool to read and view WhatsApp chat exports. Open your ZIP/TXT chat files in a clean format.",
      "url": "https://jmegaraujo.github.io/WhatsAppChatViewer/",
      "applicationCategory": "Utility",
      "operatingSystem": "Any",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "author": {
        "@type": "Person",
        "name": "José Araújo",
        "url": "https://github.com/jmegaraujo"
      }
    }
    </script>
  </head>
  <body>
    <div id="header"></div>

    <div class="box">
      <div class="content-wrapper">
        <h1 class="text">WhatsApp Chat Viewer - Read and View Your Messages</h1>
        
        <h2 class="text subtitle">Easy to Use Chat Reader</h2>
        <p class="text">Our WhatsApp Chat Viewer helps you read and view your chat history from ZIP or TXT files. Simply upload your chat export and see your messages in a clean, easy-to-read format. No downloads needed - it all works in your browser.</p>
        
        <h2 class="text subtitle">Simple and Free</h2>
        <p class="text">Whether you want to read old conversations, find important messages, or keep a backup of your chats, our tool makes it easy. Works with WhatsApp exports from your phone - just upload and start reading.</p>
        
        <div class="w-75 mx-auto">
          <div class="file-input" onclick="document.getElementById('formFile').click();">
            <p class="fileinput-label">Select File (.txt or .zip)</p>
            <input class="form-control" type="file" id="formFile" style="display: none;" accept=".txt,.zip">
          </div>
          <p class="export-tutorial-link">
            <a href="https://faq.whatsapp.com/1180414079177245/?helpref=uf_share" target="_blank" rel="noopener noreferrer">
              How to export your WhatsApp conversations
              <img src="./images/external-link.svg" alt="Redirect" width="24" height="24" loading="lazy" decoding="async" style="filter: invert(0.85) hue-rotate(300deg) saturate(2) brightness(1.2);">
            </a>
          </p>
          <div class="loader" id="topPageLoader" hidden></div>
        </div>
        <footer class="text-center mt-4">
          <p class="text" style="font-size: 0.9em; margin: 10px;">
            Made with ❤️ by <a href="https://github.com/jmegaraujo" target="_blank" rel="noopener noreferrer" style="color: #b53836; text-decoration: none;">José Araújo</a> | 
            <a href="https://github.com/jmegaraujo/WhatsAppChatViewer" target="_blank" rel="noopener noreferrer" style="color: #b53836; text-decoration: none;">View Code</a>
          </p>
        </footer>
      </div>

      <div class="menu" id="menu" hidden>
        <div class="openbtn" onclick="openNav()">
          <img src="./images/menu_24dp_E3E3E3.svg" alt="Menu" width="24" height="24" loading="lazy" decoding="async">
        </div>
      </div>
    
      <div id="overlay"></div>
      <div class="conversation" id="output" hidden></div>
      <button onclick="topFunction()" class="navigation-button" id="topButton" style="display: none;" title="Go to top">
        <img src="./images/arrow-up-thick.svg" alt="Arrow Up" width="24" height="24" loading="lazy" decoding="async">
      </button>
      <button onclick="bottomFunction()" class="navigation-button" id="bottomButton" style="display: none;" title="Go to bottom">
        <img src="./images/arrow-up-thick.svg" alt="Arrow Down" style="transform: rotate(180deg);" width="24" height="24" loading="lazy" decoding="async">
      </button>


    </div>

    <!-- Load non-critical scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js" defer></script>
    <script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="jmegaraujo" data-description="Support me on Buy me a coffee!" data-message="" data-color="#b53836" data-position="Right" data-x_margin="18" data-y_margin="18"></script>

    <script>
      function openNav() {
        const width = window.innerWidth;
        const myNav = document.getElementById("myNav");
        
        // If overlay doesn't exist yet, return void to prevent errors
        if (!myNav) return;
        
        // If overlay is open, close it
        if (myNav.style.width && myNav.style.width !== "0%") {
          closeNav();
          return;
        }
        
        if (width <= 480) {
          myNav.style.width = "75%";
        } else if (width <= 768) {
          myNav.style.width = "50%";
        } else {
          myNav.style.width = "30%";
        }
      }

      function closeNav() {
        document.getElementById("myNav").style.width = "0%";
      }

      document.addEventListener('click', function(event) {
        if (!document.getElementById("myNav")) return;
        const myNav = document.getElementById("myNav");
        const openbtn = document.querySelector('.openbtn');
        
        // Checks if the click is outside the overlay and not on the open button
        // The event.target is the element that was clicked and event is the click event
        if (myNav.style.width !== "0%" && 
            !myNav.contains(event.target) && 
            !openbtn.contains(event.target)) {
          closeNav();
        }
      });

      window.onscroll = function() {
        if (document.body.scrollTop > 40 || document.documentElement.scrollTop > 40) {
          document.getElementById('topButton').style.display = 'flex';
          document.getElementById('bottomButton').style.display = 'none';
        } else {
          document.getElementById('topButton').style.display = 'none';
          document.getElementById('bottomButton').style.display = 'flex';
        }
      };
      function topFunction() {
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      }
      function bottomFunction() {
        window.scrollTo({
          top: document.documentElement.scrollHeight,
          behavior: 'smooth'
        });
      }
    </script>

    <!-- Main application logic -->
    <script type="module">
      import { parseConversation, downloadFile, setGlobalName, loadMoreMessages } from './js/parser.js';
      import { createOverlay } from './js/overlay.js';

      // Load header content
      fetch('header.html')
        .then(response => {
          if (!response.ok) throw new Error('Network response was not ok');
          return response.text();
        })
        .then(data => {
          document.getElementById('header').innerHTML = data;
        })
        .catch(error => {
          console.error('There was a problem loading the header:', error);
        });

      // Initialize file handling
      document.getElementById('formFile').addEventListener('change', handleFileSelect);

      // Initialize intersection observer for infinite scroll
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            // Add a small delay to ensure smooth loading
            setTimeout(() => {
              loadMoreMessages();
            }, 100);
          }
        });
      });

      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        const fileExtension = file.name.split('.').pop().toLowerCase();
        
        if (fileExtension === 'txt') {
          handleTextFile(file);
        } else if (fileExtension === 'zip') {
          handleZipFile(file);
        } else {
          alert('Unsupported file type!');
        }
      }

      function handleTextFile(file) {
        const reader = new FileReader();
        reader.onload = e => {
          const textContent = e.target.result;
          const dict = [{ filename: file.name, fileData: textContent }];
          updateUIWithChatData(dict);
        };
        reader.readAsText(file);
      }

      function handleZipFile(file) {
        const reader = new FileReader();
        reader.onload = e => {
          JSZip.loadAsync(e.target.result)
            .then(processZipContents)
            .catch(err => console.error('Error processing ZIP:', err));
        };
        reader.readAsArrayBuffer(file);
      }

      let attachmentCount = 0;
      function processZipContents(zip) {
        attachmentCount = 0;
        const dict = [];
        const filePromises = Object.keys(zip.files).map(filename => {
          attachmentCount++;
          if (!filename.toLowerCase().endsWith('.txt') && !filename.toLowerCase().endsWith('.vcf')) {
            return processMediaFile(zip, filename, dict);
          }
          return processTextFile(zip, filename, dict);
        });
        document.getElementById('topPageLoader').hidden = false;
        Promise.all(filePromises)
          .then(() => updateUIWithChatData(dict))
          .catch(err => console.error('Error processing files:', err));
      }

      function processMediaFile(zip, filename, dict) {
        return zip.files[filename].async('arraybuffer')
          .then(fileData => {
            const mimeType = getMimeType(filename);
            const blob = new Blob([fileData], { type: mimeType });
            const url = URL.createObjectURL(blob);
            dict.push({ filename, fileData: blob, url });
          });
      }

      function processTextFile(zip, filename, dict) {
        return zip.files[filename].async('string')
          .then(fileData => {
            dict.push({ filename, fileData });
          });
      }

      function getMimeType(filename) {
        const ext = filename.toLowerCase().split('.').pop();
        const mimeTypes = {
          webp: 'image/webp',
          jpg: 'image/jpeg',
          jpeg: 'image/jpeg',
          png: 'image/png',
          gif: 'image/gif',
          bmp: 'image/bmp',
          svg: 'image/svg+xml',
          mp4: 'video/mp4',
          mkv: 'video/x-matroska',
          avi: 'video/x-msvideo',
          mov: 'video/quicktime',
          wmv: 'video/x-ms-wmv',
          flv: 'video/x-flv',
          webm: 'video/webm',
          mp3: 'audio/mpeg',
          opus: 'audio/ogg',
          wav: 'audio/wav',
          ogg: 'audio/ogg',
          flac: 'audio/flac',
          aac: 'audio/aac'
        };
        return mimeTypes[ext] || 'application/octet-stream';
      }

      function updateUIWithChatData(dict) {
        let users = [];
        let htmlContent = "";
        setGlobalName("");
        const { users: parsedUsers, htmlContent: parsedHtml, totalMessages } = parseConversation(dict);
        users = parsedUsers;
        htmlContent = parsedHtml;
        
        document.getElementById('output').innerHTML = htmlContent;
        document.getElementById('topPageLoader').hidden = true;
        document.getElementById('output').hidden = false;
        document.getElementById('bottomButton').style.display = 'flex';
        document.getElementById("menu").hidden = false;
        document.getElementById('overlay').innerHTML = createOverlay(users, attachmentCount);
        document.getElementById('messageCount').textContent = totalMessages;
        
        // Observe the loading indicator for infinite scroll
        const loadingIndicator = document.getElementById('loadingIndicator');
        if (loadingIndicator) {
          observer.observe(loadingIndicator);
        }

        // Also add a scroll event listener as a backup
        window.addEventListener('scroll', () => {
          const scrollPosition = window.innerHeight + window.scrollY;
          const documentHeight = document.documentElement.scrollHeight;
          
          // If we're within 200px of the bottom
          if (documentHeight - scrollPosition < 200) {
            loadMoreMessages();
          }
        });
        
        window.chatData = dict;
      }
    </script>

  </body>
</html>