<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>WhatsApp Chat Parser - Convert & Analyze Chat History</title>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="style.css" as="style">
    <link rel="preload" href="overlay.css" as="style">
    <link rel="preload" href="./images/menu_24dp_E3E3E3.svg" as="image">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" as="style">
    
    <!-- Deferred CSS loading -->
    <link rel="stylesheet" href="style.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="overlay.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" media="print" onload="this.media='all'">
    
    <!-- Meta tags -->
    <meta name="description" content="Free online tool to parse and view WhatsApp chat exports. Convert ZIP/TXT files into readable format, extract media, and analyze your conversations.">
    <meta name="keywords" content="whatsapp parser, chat analyzer, whatsapp export, chat history, message analysis, whatsapp tools">
    <meta http-equiv="Cache-Control" content="max-age=31536000, public">
    <meta property="article:modified_time" content="2024-03-14T12:00:00+00:00">
    <meta property="og:updated_time" content="2024-03-14T12:00:00+00:00">
    
    <!-- Open Graph and Twitter Cards -->
    <meta property="og:title" content="WhatsApp Chat Parser - Convert & Analyze Chat History">
    <meta property="og:description" content="Free online tool to parse, analyze and view WhatsApp chat exports. Convert ZIP/TXT chat files into readable format, extract media, and analyze conversations easily.">
    <meta property="og:image" content="https://jmegaraujo.github.io/WhatsAppChatViewer/images/og-image.png">
    <meta property="og:url" content="https://jmegaraujo.github.io/WhatsAppChatViewer/">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="WhatsApp Chat Parser - Convert & Analyze Chat History">
    <meta name="twitter:description" content="Free online tool to parse, analyze and view WhatsApp chat exports. Convert ZIP/TXT chat files into readable format, extract media, and analyze conversations easily.">
    <meta name="twitter:image" content="https://jmegaraujo.github.io/WhatsAppChatViewer/images/og-image.png">
    
    <link rel="canonical" href="https://jmegaraujo.github.io/WhatsAppChatViewer/">
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">

    <!-- Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "WhatsApp Chat Parser",
      "description": "Free online tool to parse and analyze WhatsApp chat exports. Convert ZIP/TXT chat files into readable format.",
      "url": "https://jmegaraujo.github.io/WhatsAppChatViewer/",
      "applicationCategory": "Utility",
      "operatingSystem": "Any",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "author": {
        "@type": "Person",
        "name": "José Araújo",
        "url": "https://github.com/jmegaraujo"
      }
    }
    </script>
  </head>
  <body>
    <div id="header"></div>

    <div class="box">
      <div class="content-wrapper">
        <h1 class="text">WhatsApp Chat Parser - Convert & Analyze Your Chat History</h1>
        <p class="text">Our WhatsApp Chat Parser allows you to effortlessly extract and analyze your chat data from ZIP or TXT files. With a user-friendly interface, you can easily upload your chat archives and convert them into a structured format for better readability and analysis.</p>
        <p class="text">Whether you want to review conversations, extract important information, or simply keep a record, our tool supports various file formats and provides options to customize the output to suit your needs.</p>
        <div class="w-75 mx-auto">
          <div class="file-input" onclick="document.getElementById('formFile').click();">
            <p class="fileinput-label">Select File (.txt or .zip)</p>
            <input class="form-control" type="file" id="formFile" style="display: none;" accept=".txt,.zip">
          </div>
        </div>
        <footer class="text-center mt-4">
          <p class="text" style="font-size: 0.9em; margin: 10px;">
            Made with ❤️ by <a href="https://github.com/jmegaraujo" target="_blank" rel="noopener noreferrer" style="color: #b53836; text-decoration: none;">José Araújo</a> | 
            <a href="https://github.com/jmegaraujo/WhatsAppChatViewer" target="_blank" rel="noopener noreferrer" style="color: #b53836; text-decoration: none;">View Code</a>
          </p>
        </footer>
      </div>

      <div class="menu" id="menu" hidden>
        <div class="openbtn" onclick="openNav()">
          <img src="./images/menu_24dp_E3E3E3.svg" alt="Menu" width="24" height="24" loading="lazy" decoding="async">
        </div>
      </div>
    
      <div id="overlay"></div>
      <div class="conversation" id="output" hidden></div>
    </div>

    <!-- Load non-critical scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js" defer></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="jmegaraujo" data-description="Support me on Buy me a coffee!" data-message="" data-color="#b53836" data-position="Right" data-x_margin="18" data-y_margin="18"></script>

    <script>
      function openNav() {
        const width = window.innerWidth;
        if (width <= 480) {
          document.getElementById("myNav").style.width = "75%";
        } else if (width <= 768) {
          document.getElementById("myNav").style.width = "50%";
        } else {
          document.getElementById("myNav").style.width = "30%";
        }
      }

      function closeNav() {
        document.getElementById("myNav").style.width = "0%";
      }
    </script>

    <!-- Main application logic -->
    <script type="module">
      import { parseConversation, downloadFile, setGlobalName } from './js/parser.js';
      import { createOverlay } from './js/overlay.js';

      // Load header content
      fetch('header.html')
        .then(response => {
          if (!response.ok) throw new Error('Network response was not ok');
          return response.text();
        })
        .then(data => {
          document.getElementById('header').innerHTML = data;
        })
        .catch(error => {
          console.error('There was a problem loading the header:', error);
        });

      // Initialize file handling
      document.getElementById('formFile').addEventListener('change', handleFileSelect);

      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        const fileExtension = file.name.split('.').pop().toLowerCase();
        
        if (fileExtension === 'txt') {
          handleTextFile(file);
        } else if (fileExtension === 'zip') {
          handleZipFile(file);
        } else {
          alert('Unsupported file type!');
        }
      }

      function handleTextFile(file) {
        const reader = new FileReader();
        reader.onload = e => {
          const textContent = e.target.result;
          const dict = [{ filename: file.name, fileData: textContent }];
          updateUIWithChatData(dict);
        };
        reader.readAsText(file);
      }

      function handleZipFile(file) {
        const reader = new FileReader();
        reader.onload = e => {
          JSZip.loadAsync(e.target.result)
            .then(processZipContents)
            .catch(err => console.error('Error processing ZIP:', err));
        };
        reader.readAsArrayBuffer(file);
      }

      function processZipContents(zip) {
        const dict = [];
        const filePromises = Object.keys(zip.files).map(filename => {
          if (!filename.toLowerCase().endsWith('.txt') && !filename.toLowerCase().endsWith('.vcf')) {
            return processMediaFile(zip, filename, dict);
          }
          return processTextFile(zip, filename, dict);
        });

        Promise.all(filePromises)
          .then(() => updateUIWithChatData(dict))
          .catch(err => console.error('Error processing files:', err));
      }

      function processMediaFile(zip, filename, dict) {
        return zip.files[filename].async('arraybuffer')
          .then(fileData => {
            const mimeType = getMimeType(filename);
            const blob = new Blob([fileData], { type: mimeType });
            const url = URL.createObjectURL(blob);
            dict.push({ filename, fileData: blob, url });
          });
      }

      function processTextFile(zip, filename, dict) {
        return zip.files[filename].async('string')
          .then(fileData => {
            dict.push({ filename, fileData });
          });
      }

      function getMimeType(filename) {
        const ext = filename.toLowerCase().split('.').pop();
        const mimeTypes = {
          webp: 'image/webp',
          jpg: 'image/jpeg',
          jpeg: 'image/jpeg',
          png: 'image/png',
          gif: 'image/gif',
          bmp: 'image/bmp',
          svg: 'image/svg+xml',
          mp4: 'video/mp4',
          mkv: 'video/x-matroska',
          avi: 'video/x-msvideo',
          mov: 'video/quicktime',
          wmv: 'video/x-ms-wmv',
          flv: 'video/x-flv',
          webm: 'video/webm',
          mp3: 'audio/mpeg',
          opus: 'audio/ogg',
          wav: 'audio/wav',
          ogg: 'audio/ogg',
          flac: 'audio/flac',
          aac: 'audio/aac'
        };
        return mimeTypes[ext] || 'application/octet-stream';
      }

      function updateUIWithChatData(dict) {
        let users = [];
        let htmlContent = "";
        setGlobalName("");
        ({ users, htmlContent } = parseConversation(dict));
        
        document.getElementById('output').innerHTML = htmlContent;
        document.getElementById('output').hidden = false;
        document.getElementById("menu").hidden = false;
        document.getElementById('overlay').innerHTML = createOverlay(users);
        
        window.chatData = dict;
      }
    </script>

  </body>
</html>